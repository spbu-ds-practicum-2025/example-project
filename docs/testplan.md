# План сквозного тестирования электронного кошелька (MVP)

## Введение

Данный документ описывает сценарии сквозного (end-to-end) тестирования MVP системы «Электронный кошелек». Все тесты предназначены для ручного выполнения и фокусируются на взаимодействии с системой через REST API.

**Охват MVP**: переводы между счетами, просмотр баланса и истории операций.

**Предусловия для всех тестов**:
- Система полностью развернута и доступна
- API Gateway доступен по адресу `http://localhost:8080`
- В системе существуют тестовые счета с известными идентификаторами
- Для отправки HTTP-запросов можно использовать любой HTTP-клиент (curl, Postman, HTTPie и т.д.)

---

## 1. Тестирование переводов между счетами

### Тест 1.1: Успешный перевод средств

**Цель**: проверить полный цикл перевода денег от одного пользователя другому.

**Предусловия**:
- Счет А существует с балансом 5000.00 RUB
- Счет Б существует с балансом 1000.00 RUB
- Известны ID обоих счетов

**Шаги**:
1. Отправить HTTP-запрос:
   ```
   POST http://localhost:8080/accounts/{account-A}/transfers
   Headers:
     Content-Type: application/json
     X-Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000
   Body:
   {
     "recipientId": "{account-B}",
     "amount": {
       "value": "250.00",
       "currencyCode": "RUB"
     }
   }
   ```

**Ожидаемый результат**:
- HTTP статус: 200 OK
- Тело ответа содержит ID операции:
  ```json
  {
    "operationId": "<uuid>"
  }
  ```
- Баланс счета А уменьшился на 250.00 RUB и составляет 4750.00 RUB
- Баланс счета Б увеличился на 250.00 RUB и составляет 1250.00 RUB
- Операция отображается в истории обоих счетов
- Время выполнения операции не превышает 2 секунд

### Тест 1.2: Перевод с недостаточным балансом

**Цель**: проверить, что система корректно обрабатывает попытку перевода суммы, превышающей баланс.

**Предусловия**:
- Счет А существует с балансом 100.00 RUB
- Счет Б существует с балансом 500.00 RUB

**Шаги**:
1. Отправить HTTP-запрос:
   ```
   POST http://localhost:8080/accounts/{account-A}/transfers
   Headers:
     Content-Type: application/json
     X-Idempotency-Key: 987e6543-e21b-34d3-c456-426614174999
   Body:
   {
     "recipientId": "{account-B}",
     "amount": {
       "value": "200.00",
       "currencyCode": "RUB"
     }
   }
   ```

**Ожидаемый результат**:
- HTTP статус: 400 (Bad Request)
- Тело ответа содержит:
  ```json
  {
    "id": "<uuid>",
    "code": "400_BAD_REQUEST",
    "description": "Недостаточно средств на счете"
  }
  ```
- Баланс счета А остается 100.00 RUB
- Баланс счета Б остается 500.00 RUB
- Деньги не списываются
- В базе данных не создается запись об успешной транзакции

### Тест 1.3: Перевод на несуществующий счет

**Цель**: проверить обработку перевода на несуществующий счет получателя.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Счет с указанным ID получателя не существует в системе

**Шаги**:
1. Отправить HTTP-запрос:
   ```
   POST http://localhost:8080/accounts/{account-A}/transfers
   Headers:
     Content-Type: application/json
     X-Idempotency-Key: <новый-uuid>
   Body:
   {
     "recipientId": "non-existent-recipient",
     "amount": {
       "value": "100.00",
       "currencyCode": "RUB"
     }
   }
   ```

**Ожидаемый результат**:
- HTTP статус: 404 (Not Found)
- Тело ответа содержит:
  ```json
  {
    "id": "<uuid>",
    "code": "404_NOT_FOUND",
    "description": "Счет получателя не найден"
  }
  ```
- Баланс счета А остается неизменным: 1000.00 RUB
- Деньги не списываются

### Тест 1.4: Последовательные переводы с одного счета

**Цель**: проверить корректность выполнения нескольких переводов подряд.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Счета Б, В, Г существуют

**Шаги**:
1. Выполнить первый перевод (100.00 RUB на счет Б) с уникальным ключом идемпотентности
2. Дождаться успешного ответа (HTTP 200)
3. Выполнить второй перевод (150.00 RUB на счет В) с новым ключом идемпотентности
4. Дождаться успешного ответа (HTTP 200)
5. Выполнить третий перевод (200.00 RUB на счет Г) с новым ключом идемпотентности
6. Дождаться успешного ответа (HTTP 200)
7. Проверить балансы через GET-запросы

**Ожидаемый результат**:
- Все три перевода выполнены успешно
- Баланс счета А: 550.00 RUB (1000 - 100 - 150 - 200)
- Баланс счета Б: увеличен на 100.00 RUB
- Баланс счета В: увеличен на 150.00 RUB
- Баланс счета Г: увеличен на 200.00 RUB
- Все три операции отображаются в истории счета А

---

## 2. Тестирование идемпотентности операций

### Тест 2.1: Повторная отправка успешного перевода

**Цель**: проверить, что система корректно обрабатывает повторную отправку запроса с одинаковым ключом идемпотентности.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Счет Б существует с балансом 500.00 RUB
- Известен ключ идемпотентности для операции

**Шаги**:
1. Отправить первый HTTP-запрос на перевод 100.00 RUB с ключом идемпотентности `KEY-001`
2. Дождаться успешного ответа (HTTP 200) и сохранить `operationId` из ответа
3. Проверить балансы счетов А и Б
4. Повторно отправить идентичный HTTP-запрос с тем же ключом `KEY-001`

**Ожидаемый результат**:
- Первый запрос выполнен успешно, возвращен ID операции
- Второй запрос возвращает тот же ID операции
- Баланс счета А: 900.00 RUB (списано только один раз)
- Баланс счета Б: 600.00 RUB (зачислено только один раз)
- В истории операций только одна запись о переводе

### Тест 2.2: Повторная отправка неуспешного перевода

**Цель**: проверить идемпотентность при повторной попытке неуспешной операции.

**Предусловия**:
- Счет А существует с балансом 100.00 RUB
- Счет Б существует

**Шаги**:
1. Отправить HTTP-запрос на перевод 200.00 RUB (больше баланса) с ключом `KEY-002`
2. Получить ответ с ошибкой (HTTP 400)
3. Повторить тот же запрос с тем же ключом идемпотентности `KEY-002`

**Ожидаемый результат**:
- Оба запроса возвращают одинаковую ошибку
- Баланс счета А остается 100.00 RUB
- Операция не выполняется ни при первом, ни при втором запросе

### Тест 2.3: Разные операции с разными ключами идемпотентности

**Цель**: проверить, что разные ключи идемпотентности позволяют выполнять независимые операции.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Счет Б существует

**Шаги**:
1. Отправить первый HTTP-запрос на перевод 100.00 RUB на счет Б с ключом `KEY-003`
2. Отправить второй HTTP-запрос на перевод 150.00 RUB на счет Б с другим ключом `KEY-004`

**Ожидаемый результат**:
- Обе операции выполнены успешно
- Получены два разных ID операций
- Баланс счета А: 750.00 RUB (1000 - 100 - 150)
- Баланс счета Б: увеличен на 250.00 RUB
- В истории отображаются обе операции

---

## 3. Тестирование просмотра истории операций

### Тест 3.1: Просмотр полной истории операций

**Цель**: проверить получение списка всех операций по счету.

**Предусловия**:
- Счет А существует
- По счету А выполнено несколько операций (переводы, пополнения)

**Шаги**:
1. Отправить HTTP-запрос для получения истории операций:
   ```
   GET http://localhost:8080/accounts/{account-A}/operations
   ```

**Ожидаемый результат**:
- HTTP статус: 200 OK
- Тело ответа содержит массив операций:
  ```json
  {
    "content": [
      {
        "operationId": "<uuid>",
        "type": "TRANSFER",
        "amount": {...},
        "timestamp": "2025-11-12T10:30:00Z",
        "status": "SUCCESS",
        "senderId": "...",
        "recipientId": "..."
      },
      ...
    ],
    "afterId": "<uuid>"
  }
  ```
- Операции отсортированы по времени (новые сверху)

### Тест 3.2: Просмотр истории с пагинацией

**Цель**: проверить корректность работы пагинации при просмотре истории.

**Предусловия**:
- Счет А существует
- По счету А выполнено более 20 операций

**Шаги**:
1. Отправить первый HTTP-запрос с ограничением:
   ```
   GET http://localhost:8080/accounts/{account-A}/operations?limit=10
   ```
2. Сохранить `afterId` из ответа
3. Отправить второй HTTP-запрос для следующей страницы:
   ```
   GET http://localhost:8080/accounts/{account-A}/operations?limit=10&afterId={afterId}
   ```

**Ожидаемый результат**:
- Первый запрос возвращает 10 операций
- Второй запрос возвращает следующие 10 операций
- Операции не дублируются между запросами
- Все операции возвращаются в правильном хронологическом порядке

### Тест 3.3: Актуальность истории после новой операции

**Цель**: проверить, что новые операции сразу появляются в истории.

**Предусловия**:
- Счет А существует
- Счет Б существует

**Шаги**:
1. Отправить GET-запрос для получения текущей истории счета А
2. Выполнить новый перевод 100.00 RUB со счета А на счет Б
3. Дождаться успешного ответа (HTTP 200)
4. Сразу же повторно отправить GET-запрос для получения истории счета А

**Ожидаемый результат**:
- Новая операция перевода появляется в истории
- Операция содержит корректные данные (сумма, получатель, статус)
- История обновляется в течение 5 секунд после завершения операции

---

## 4. Тестирование конкурентности

### Тест 4.1: Множественные параллельные переводы с одного счета

**Цель**: проверить, как система обрабатывает одновременные запросы.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Существуют счета Б, В, Г

**Шаги**:
1. Одновременно (в течение 1 секунды) отправить несколько HTTP-запросов с разными ключами идемпотентности:
   - Перевод 300.00 RUB со счета А на счет Б (ключ: KEY-A1)
   - Перевод 300.00 RUB со счета А на счет В (ключ: KEY-A2)
   - Перевод 300.00 RUB со счета А на счет Г (ключ: KEY-A3)
   - Перевод 300.00 RUB со счета А на счет Д (ключ: KEY-A4)
   - Перевод 300.00 RUB со счета А на счет Е (ключ: KEY-A5)
2. Дождаться результатов всех операций
3. Проверить балансы всех счетов

**Ожидаемый результат**:
- 3 перевода выполняются успешно (HTTP 200)
- 2 перевода возвращают ошибку "Недостаточно средств" (HTTP 400)
- Итоговый баланс счета А = 100.00 RUB (после 3 успешных переводов по 300.00)
- Баланс НИКОГДА не становится отрицательным
- Сумма всех балансов в системе остается константой
- Нет race conditions или lost updates

---

## 5. Комплексные сквозные сценарии

### Тест 5.1: Полный жизненный цикл переводов

**Цель**: проверить типичный сценарий использования системы.

**Предусловия**:
- Счет А существует с балансом 5000.00 RUB
- Счет Б существует с балансом 1000.00 RUB
- Счет В существует с балансом 0.00 RUB

**Шаги**:
1. Проверить начальный баланс счета А: `GET /accounts/{account-A}`
2. Перевести 1000.00 RUB со счета А на счет Б: `POST /accounts/{account-A}/transfers`
3. Перевести 500.00 RUB со счета А на счет В: `POST /accounts/{account-A}/transfers`
4. Проверить баланс счета А: `GET /accounts/{account-A}` (ожидаем 3500.00 RUB)
5. Просмотреть историю счета А: `GET /accounts/{account-A}/operations`
6. Проверить баланс счета Б: `GET /accounts/{account-B}` (ожидаем 2000.00 RUB)
7. Проверить баланс счета В: `GET /accounts/{account-V}` (ожидаем 500.00 RUB)

**Ожидаемый результат**:
- Все операции выполняются успешно
- Все балансы корректны на каждом этапе
- История операций содержит все выполненные переводы
- Общая сумма всех балансов сохраняется

### Тест 5.2: Цепочка переводов между несколькими пользователями

**Цель**: проверить корректность выполнения последовательных переводов через нескольких участников.

**Предусловия**:
- Счет А существует с балансом 1000.00 RUB
- Счет Б существует с балансом 0.00 RUB
- Счет В существует с балансом 0.00 RUB
- Счет Г существует с балансом 0.00 RUB

**Шаги**:
1. Отправить HTTP-запрос на перевод 500.00 RUB со счета А на счет Б: `POST /accounts/{account-A}/transfers`
2. Отправить HTTP-запрос на перевод 300.00 RUB со счета Б на счет В: `POST /accounts/{account-B}/transfers`
3. Отправить HTTP-запрос на перевод 100.00 RUB со счета В на счет Г: `POST /accounts/{account-V}/transfers`
4. Проверить балансы всех четырех счетов через GET-запросы

**Ожидаемый результат**:
- Все переводы выполнены успешно
- Баланс счета А: 500.00 RUB
- Баланс счета Б: 200.00 RUB (500 - 300)
- Баланс счета В: 200.00 RUB (300 - 100)
- Баланс счета Г: 100.00 RUB
- Общая сумма балансов: 1000.00 RUB (неизменна)
- Все операции отображаются в соответствующих историях

---

## 6. Проверка консистентности данных

### Тест 6.1: Согласованность данных в истории операций

**Цель**: проверить, что история операций согласуется с текущим состоянием балансов.

**Предусловия**:
- Счет А существует с известным начальным балансом

**Шаги**:
1. Запомнить начальный баланс счета А через `GET /accounts/{account-A}`
2. Выполнить несколько переводов (минимум 3 операции)
3. Запросить полную историю операций: `GET /accounts/{account-A}/operations`
4. Вручную пересчитать баланс на основе истории операций
5. Запросить текущий баланс через `GET /accounts/{account-A}` и сравнить

**Ожидаемый результат**:
- Расчетный баланс (начальный баланс + все операции) совпадает с фактическим
- Все операции учтены в истории
- Нет расхождений
