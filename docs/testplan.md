# План тестирования электронного кошелька

## Тестирование переводов

### 1. Полный цикл успешного перевода через REST API

**Сценарий**: Перевод от клиента до обновления базы данных и публикации события

- **Given**: 
  - Вся инфраструктура запущена (API Gateway, Bank Service, PostgreSQL, RabbitMQ)
  - Счет А: баланс 5000.00 RUB
  - Счет Б: баланс 1000.00 RUB
- **When**: 
  1. Клиент отправляет HTTP POST на `http://localhost:8080/accounts/{id-A}/transfers`:
     ```json
     {
       "recipientId": "{id-B}",
       "amount": {
         "value": "250.00",
         "currencyCode": "RUB"
       }
     }
     ```
  2. С заголовком `X-Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000`
- **Then**: 
  - Клиент получает HTTP 200 с `operationId`
  - В PostgreSQL:
    - Баланс счета А: 4750.00 RUB
    - Баланс счета Б: 1250.00 RUB
    - Таблица `transfers` содержит запись со статусом "SUCCESS"
  - В RabbitMQ опубликовано событие в exchange `bank.operations` с routing key `bank.operations.transfer.completed`
  - Событие содержит корректные данные операции (senderId, recipientId, amount, status)
  - Время выполнения операции < 2 секунд

### 2. Идемпотентность на уровне системы

**Сценарий**: Повторный HTTP запрос с тем же ключом идемпотентности

- **Given**: 
  - Выполнен первый запрос на перевод 100.00 RUB с `X-Idempotency-Key: 123e4567-e89b-12d3-a456-426614174000`
  - Перевод успешно завершен, получен `operationId`
  - Балансы обновлены
- **When**: 
  - Клиент отправляет идентичный HTTP запрос с тем же `X-Idempotency-Key: 123e4567-e89b-12d3-a456-426614174000`
- **Then**: 
  - HTTP статус: 200 OK
  - Возвращается тот же `operationId`, что и при первом запросе
  - Балансы счетов НЕ изменяются повторно
  - В БД НЕ создается новая запись в таблице `transfers`
  - Событие в RabbitMQ НЕ публикуется повторно

### 3. Перевод с недостаточным балансом

**Сценарий**: Попытка перевода суммы, превышающей баланс счета

- **Given**: 
  - Счет А: баланс 100.00 RUB
  - Счет Б: баланс 500.00 RUB
- **When**: 
  - Клиент отправляет HTTP POST запрос на перевод 200.00 RUB со счета А на счет Б
  - С заголовком `X-Idempotency-Key: 987e6543-e21b-34d3-c456-426614174999`
- **Then**: 
  - HTTP статус: 400 Bad Request
  - Тело ответа содержит:
    - `id`: UUID ошибки
    - `code`: "400_BAD_REQUEST" или специфичный код ошибки
    - `description`: информация о недостаточном балансе
  - Балансы обоих счетов остаются неизменными
  - В PostgreSQL создается запись в `transfers` со статусом "FAILED"
  - Событие в RabbitMQ НЕ публикуется (или публикуется со статусом FAILED)

### 4. Перевод на несуществующий счет

**Сценарий**: Попытка перевода на счет, которого нет в базе данных

- **Given**: 
  - Счет А: баланс 1000.00 RUB существует
  - Счет с UUID `{несуществующий-id}` отсутствует в БД
- **When**: 
  - Клиент отправляет HTTP POST запрос на перевод со счета А на `{несуществующий-id}`
- **Then**: 
  - HTTP статус: 404 Not Found
  - Тело ответа содержит:
    - `id`: UUID ошибки
    - `code`: "404_NOT_FOUND"
    - `description`: информация о том, что счет не найден
  - Баланс счета А не изменяется
  - Запись в таблице `transfers` НЕ создается
  - Событие в RabbitMQ НЕ публикуется

### 5. Валидация входных данных

**Сценарий**: Запрос с невалидными данными

- **Given**: API Gateway и Bank Service работают корректно
- **When**: Клиент отправляет HTTP POST запрос с невалидными данными:
  - Отрицательная сумма: `"value": "-100.00"`
  - ИЛИ невалидный формат UUID в `recipientId`
  - ИЛИ невалидный формат суммы: `"value": "100.555"`
  - ИЛИ отсутствует заголовок `X-Idempotency-Key`
- **Then**: 
  - HTTP статус: 400 Bad Request
  - Тело ответа содержит:
    - `id`: UUID ошибки
    - `code`: "400_BAD_REQUEST"
    - `description`: описание конкретной ошибки валидации
  - Балансы счетов не изменяются
  - Данные не записываются в БД

### 6. Обработка недоступности RabbitMQ

**Сценарий**: Выполнение перевода при недоступности брокера сообщений

- **Given**: 
  - API Gateway и Bank Service работают
  - PostgreSQL доступна
  - RabbitMQ остановлен или недоступен
  - Счет А: баланс 1000.00 RUB
  - Счет Б: баланс 500.00 RUB
- **When**: 
  - Клиент отправляет HTTP POST запрос на перевод 100.00 RUB
- **Then**: 
  - HTTP статус: 200 OK (перевод выполняется успешно)
  - Возвращается `operationId`
  - В PostgreSQL:
    - Баланс счета А: 900.00 RUB
    - Баланс счета Б: 600.00 RUB
    - Таблица `transfers` содержит запись со статусом "SUCCESS"
  - В логах Bank Service фиксируется ошибка публикации события
  - Система остается в консистентном состоянии (eventual consistency)

### 7. Обработка недоступности Bank Service

**Сценарий**: API Gateway не может подключиться к Bank Service

- **Given**: 
  - API Gateway запущен
  - Bank Service остановлен или недоступен по gRPC
- **When**: 
  - Клиент отправляет HTTP POST запрос на перевод
- **Then**: 
  - HTTP статус: 500 Internal Server Error или 503 Service Unavailable
  - Тело ответа содержит:
    - `id`: UUID ошибки
    - `code`: код ошибки сервера
    - `description`: информация о недоступности сервиса
  - Клиент может повторить запрос позже с тем же ключом идемпотентности

### 8. Параллельные переводы с одного счета

**Сценарий**: Конкурентные переводы для проверки корректности блокировок

- **Given**: 
  - Счет А: баланс 1000.00 RUB
  - Счета Б, В, Г, Д существуют
- **When**: 
  - Одновременно отправляется 5 параллельных HTTP запросов:
    - Перевод 300.00 RUB со счета А на счет Б
    - Перевод 300.00 RUB со счета А на счет В
    - Перевод 300.00 RUB со счета А на счет Г
    - Перевод 300.00 RUB со счета А на счет Д
    - Перевод 300.00 RUB со счета А на счет Е
  - Все запросы с уникальными ключами идемпотентности
- **Then**: 
  - 3 перевода выполняются успешно (HTTP 200)
  - 2 перевода возвращают ошибку "insufficient funds" (HTTP 400)
  - Итоговый баланс счета А = 100.00 RUB (или 400.00 RUB при 2 успешных)
  - Баланс НИКОГДА не становится отрицательным
  - Сумма всех балансов в системе остается константой
  - Нет race conditions или lost updates

---

## Инструменты для выполнения тестов

### Ручное тестирование
- **Postman**: для HTTP запросов к API Gateway
- **DBeaver**: для проверки состояния PostgreSQL
- **RabbitMQ Management UI**: для проверки публикации событий 

### Автоматизированное тестирование
- **Go test**: интеграционные тесты с использованием testcontainers
- **Docker Compose**: для поднятия всей инфраструктуры